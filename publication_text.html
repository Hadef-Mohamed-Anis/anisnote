<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://emoji-css.afeld.me/emoji.css" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; background-color: #121212; font-family: 'Poppins', sans-serif; color: white; height: 100%; }
        
        /* Header */
        .top-nav {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
            background-color: #121212; position: sticky; top: 0; z-index: 100;
        }
        .user-info-header { display: flex; align-items: center; gap: 10px; flex: 1; margin-left: 15px; cursor: pointer; }
        .avatar-small { width: 32px; height: 32px; border-radius: 50%; background: #444; object-fit: cover; }
        .username-header { font-size: 14px; font-weight: 600; margin-right: 10px;}
        
        /* Follow Button Style */
        .follow-btn {
            background: transparent;
            border: 1px solid #ff2442;
            color: #ff2442;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: none; 
        }
        .follow-btn.following {
            background: #333;
            border-color: #333;
            color: #ccc;
        }

        /* Menu Options Modal */
        .options-menu {
            position: absolute;
            top: 50px;
            right: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 5px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            width: 120px;
            z-index: 1000;
        }
        .options-menu.show { display: flex; }
        .menu-item {
            padding: 10px 15px;
            font-size: 14px;
            color: #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .menu-item:hover { background: #3a3a3a; }
        .menu-item.danger { color: #ff4d4f; }
        .menu-item.disabled { color: #666; cursor: not-allowed; }

        /* Content */
        .scroll-container { padding: 0 15px 80px 15px; overflow-y: auto; }
        .post-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; margin-top: 10px; }
        .post-content { font-size: 15px; line-height: 1.6; color: #eee; white-space: pre-wrap; margin-bottom: 15px; }
        .post-meta { font-size: 12px; color: #666; display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 15px; }

        /* Comments Section */
        .comments-section { margin-top: 10px; }
        .comment-tabs { font-size: 14px; font-weight: 600; margin-bottom: 15px; color: #888; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 20px; }
        .comment-avatar { width: 32px; height: 32px; border-radius: 50%; background: #333; flex-shrink: 0; }
        .comment-body { flex: 1; }
        .comment-user { font-size: 13px; color: #888; font-weight: 600; margin-bottom: 2px; }
        .comment-text { font-size: 14px; color: #ddd; margin-bottom: 5px; }
        .comment-image { max-width: 150px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .comment-actions { display: flex; gap: 15px; font-size: 12px; color: #666; font-weight: 600; align-items: center; }
        .action-link { cursor: pointer; }
        .comment-like-container { display: flex; align-items: center; gap: 5px; margin-left: auto; cursor: pointer; }
        .comment-like-btn.liked { color: #ff2442; }

        /* Footer Input */
        .bottom-input-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #121212; border-top: 1px solid #222;
            padding: 10px 15px; padding-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between; z-index: 200; box-sizing: border-box;
        }
        
        .input-wrapper {
            background: #1e1e1e; border-radius: 20px; padding: 8px 15px;
            display: flex; align-items: center; flex: 1; margin-right: 15px;
        }
        .input-wrapper input {
            background: transparent; border: none; color: white; width: 100%; outline: none; font-size: 14px;
        }
        .input-icons { display: flex; gap: 10px; color: #888; font-size: 18px; margin-left: 5px; align-items: center;}
        
        .action-icons-right { display: flex; gap: 20px; color: #efefef; font-size: 22px; align-items: center; }
        .icon-with-count { display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 2px; }
        .icon-with-count i { font-size: 24px; cursor: pointer; transition: color 0.2s; }
        .liked-active { color: #ff2442; }
        .collected-active { color: #ffdb00; }

        /* Loader */
        #loadingOverlay { position: fixed; inset: 0; background: #121212; display: flex; justify-content: center; align-items: center; z-index: 999; }
        
        /* Modal for Image Preview */
        .image-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:3000;}
        .image-modal img { max-width:90%; max-height:90%; }
        
        /* Emoji Picker */
        .emoji-picker {
            position: fixed; bottom: 70px; left: 15px; right: 15px; background: #1e1e1e; border-radius: 12px; padding: 10px; display: none; max-height: 200px; overflow-y: auto; z-index: 300; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 8px; }
        .emoji-grid i { font-size: 24px; cursor: pointer; transition: transform 0.1s; }
        .emoji-grid i:hover { transform: scale(1.2); }

        /* Image Slider System */
        .image-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 0;
            border-radius: 12px;
            scrollbar-width: none;
        }
        .image-slider::-webkit-scrollbar { display: none; }

        .slider-img {
            min-width: 100%;
            height: 400px;
            object-fit: cover;
            scroll-snap-align: start;
            background: #1e1e20;
            cursor: zoom-in;
            transition: opacity 0.3s;
        }
        .slider-img:active { opacity: 0.8; }

        /* Dots */
        .slider-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .dot {
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .dot.active {
            background: #7F30FF;
            transform: scale(1.2);
        }
        
        /* Action Icon Holder */
        .header-action-icon {
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="emojiPicker" class="emoji-picker">
        <div class="emoji-grid">
            <i class="em em-smile" data-emoji="ðŸ˜„"></i>
            <i class="em em-laughing" data-emoji="ðŸ˜†"></i>
            <i class="em em-wink" data-emoji="ðŸ˜‰"></i>
            <i class="em em-heart_eyes" data-emoji="ðŸ˜"></i>
            <i class="em em-sunglasses" data-emoji="ðŸ˜Ž"></i>
            <i class="em em-cry" data-emoji="ðŸ˜¢"></i>
            <i class="em em-angry" data-emoji="ðŸ˜ "></i>
            <i class="em em-thumbs_up" data-emoji="ðŸ‘"></i>
            <i class="em em-clap" data-emoji="ðŸ‘"></i>
            <i class="em em-fire" data-emoji="ðŸ”¥"></i>
        </div>
    </div>

    <div id="loadingOverlay"><i class="fas fa-spinner fa-spin fa-2x"></i></div>

    <div class="top-nav">
        <i class="fas fa-arrow-left" onclick="history.back()" style="font-size: 20px; cursor: pointer;"></i>
        
        <div class="user-info-header" id="userInfoContainer">
            <img id="postUserAvatar" src="https://via.placeholder.com/32" class="avatar-small">
            <span id="postUserName" class="username-header">User</span>
        </div>
        
        <button id="followBtn" class="follow-btn">Follow</button>

        <div id="headerActionContainer" style="margin-left: 10px;">
            </div>
        
        <div id="ownerMenu" class="options-menu">
            <div class="menu-item disabled"><i class="fas fa-pen"></i> Edit</div>
            <div class="menu-item danger" id="deletePostBtn"><i class="fas fa-trash"></i> Delete</div>
        </div>
    </div>

    <div class="scroll-container">
        <div class="slider-wrapper">
            <div id="imageGallery" class="image-slider"></div>
            <div id="sliderDots" class="slider-dots"></div>
        </div>
        <h2 id="postTitle" class="post-title"></h2>
        <div id="postContent" class="post-content"></div>
        <div class="post-meta">
            <span id="postDate">Just now</span>
            <span><i class="far fa-eye"></i> <span id="viewCountDisplay">0</span> View</span>
        </div>

        <div class="comments-section">
            <div class="comment-tabs">Comments <span id="commentsTotal">0</span></div>
            <div id="commentsList">
            </div>
        </div>
    </div>

    <div class="bottom-input-bar">
        <div class="input-wrapper">
            <input type="text" id="commentInput" placeholder="Say something...">
            <div class="input-icons">
                <i class="fas fa-at"></i>
                <i class="far fa-smile"></i>
                <label for="imgUpload" style="cursor: pointer;"><i class="far fa-image"></i></label>
                <input type="file" id="imgUpload" accept="image/*" style="display: none;">
                <i class="fas fa-paper-plane" id="sendBtn" style="color: #ff2442; cursor: pointer; margin-left:5px;"></i>
            </div>
        </div>
        <div class="action-icons-right">
            <div class="icon-with-count">
                <i class="far fa-heart" id="likeBtn"></i>
                <span id="likeCount">0</span>
            </div>
            <div class="icon-with-count">
                <i class="far fa-star" id="collectBtn"></i>
                <span id="collectCount">0</span>
            </div>
            <div class="icon-with-count">
                <i class="far fa-comment-dots"></i>
                <span id="commentIconCount">0</span>
            </div>
        </div>
    </div>

    <div id="imageModal" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.9); align-items:center; justify-content:center; cursor: zoom-out;">
        <span style="position:absolute; top:20px; right:30px; color:white; font-size:40px; font-weight:bold; cursor:pointer;" onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
        <img id="fullImage" style="max-width:95%; max-height:95%; object-fit:contain; border-radius: 8px;">
    </div>
    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, increment, runTransaction, serverTimestamp, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuEfa4lBdoarHqUBmpWnVdYEhLYMUW0Wk",
            authDomain: "rednote-99494.firebaseapp.com",
            projectId: "rednote-99494",
            storageBucket: "rednote-99494.firebasestorage.app",
            messagingSenderId: "381708373042",
            appId: "1:381708373042:web:3b2b66b9aefba8b98bc02b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dsvxv96q8/image/upload";
        const CLOUDINARY_UPLOAD_PRESET = "Rednote";

        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');

        let currentUser = null;
        let postPublisherId = null;
        let replyingTo = null; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (!postId) {
                    alert('Post not found');
                    window.location.href = 'home.html';
                    return;
                }
                await loadPostData();
                setupRealtimeComments();
                registerView();
                checkInteractionStatus();
                document.getElementById('loadingOverlay').style.display = 'none';
            } else {
                window.location.href = "index.html";
            }
        });

        async function loadPostData() {
            const docRef = doc(db, "posts", postId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const postData = docSnap.data();
                postPublisherId = postData.userId;

                // --- Navigation Logic to Me Page ---
                document.getElementById('userInfoContainer').onclick = () => {
                    window.location.href = `me.html?uid=${postPublisherId}`;
                };

                // --- Header Logic: Owner vs Visitor ---
                const actionContainer = document.getElementById('headerActionContainer');
                const followBtn = document.getElementById('followBtn');

                if (currentUser.uid === postPublisherId) {
                    // It's the Owner
                    actionContainer.innerHTML = `<i class="fas fa-ellipsis-h header-action-icon" id="ownerOptionsBtn"></i>`;
                    
                    setTimeout(() => {
                        const menuBtn = document.getElementById('ownerOptionsBtn');
                        const menu = document.getElementById('ownerMenu');
                        
                        menuBtn.onclick = (e) => {
                            e.stopPropagation();
                            menu.classList.toggle('show');
                        };
                        
                        document.addEventListener('click', (e) => {
                            if (!menu.contains(e.target) && e.target !== menuBtn) {
                                menu.classList.remove('show');
                            }
                        });

                        document.getElementById('deletePostBtn').onclick = async () => {
                            if(confirm("Are you sure you want to delete this note?")) {
                                await deleteDoc(doc(db, "posts", postId));
                                alert("Deleted successfully");
                                window.location.href = "home.html";
                            }
                        };
                    }, 100);

                } else {
                    // It's a Visitor
                    actionContainer.innerHTML = `<i class="fas fa-share header-action-icon" onclick="alert('Share feature coming soon!')"></i>`;
                    followBtn.style.display = 'block';
                    checkFollowStatus(); 
                    followBtn.onclick = () => toggleFollow();
                }

                if (postPublisherId) {
                    const userRef = doc(db, "users", postPublisherId);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        document.getElementById('postUserName').innerText = userData.displayName || "User";
                        if (userData.photoURL) document.getElementById('postUserAvatar').src = userData.photoURL;
                    } else {
                        document.getElementById('postUserName').innerText = postData.userName || "User";
                        if (postData.userPhoto) document.getElementById('postUserAvatar').src = postData.userPhoto;
                    }
                }

                if (postData.hasImages && postData.images && postData.images.length > 0) {
                    const gallery = document.getElementById('imageGallery');
                    const dotsContainer = document.getElementById('sliderDots');
                    const modal = document.getElementById('imageModal');
                    const fullImg = document.getElementById('fullImage');

                    postData.images.forEach((url, index) => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'slider-img';
                        img.onclick = () => {
                            fullImg.src = url;
                            modal.style.display = 'flex';
                        };
                        gallery.appendChild(img);

                        if (postData.images.length > 1) {
                            const dot = document.createElement('div');
                            dot.className = `dot ${index === 0 ? 'active' : ''}`;
                            dotsContainer.appendChild(dot);
                        }
                    });

                    gallery.onscroll = () => {
                        const scrollIndex = Math.round(gallery.scrollLeft / gallery.clientWidth);
                        const dots = dotsContainer.querySelectorAll('.dot');
                        dots.forEach((dot, i) => dot.classList.toggle('active', i === scrollIndex));
                    };
                }

                document.getElementById('postTitle').innerText = postData.title || "Note";
                document.getElementById('postContent').innerText = postData.content;
                const date = postData.createdAt?.toDate ? postData.createdAt.toDate() : new Date();
                document.getElementById('postDate').innerText = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.getElementById('likeCount').innerText = postData.likes || 0;
                document.getElementById('viewCountDisplay').innerText = postData.views || 0;
                document.getElementById('collectCount').innerText = postData.collects || 0;

            } else {
                alert("Post does not exist!");
                history.back();
            }
        }

        async function checkFollowStatus() {
            if (!currentUser || !postPublisherId) return;
            const followRef = doc(db, "users", currentUser.uid, "following", postPublisherId);
            const snap = await getDoc(followRef);
            updateFollowBtnUI(snap.exists());
        }

        function updateFollowBtnUI(isFollowing) {
            const btn = document.getElementById('followBtn');
            if (isFollowing) {
                btn.innerText = "Following";
                btn.classList.add('following');
            } else {
                btn.innerText = "Follow";
                btn.classList.remove('following');
            }
        }

        async function toggleFollow() {
            const btn = document.getElementById('followBtn');
            const isFollowing = btn.classList.contains('following');
            
            updateFollowBtnUI(!isFollowing);

            const currentUserRef = doc(db, "users", currentUser.uid);
            const publisherRef = doc(db, "users", postPublisherId);
            
            const followingRef = doc(db, "users", currentUser.uid, "following", postPublisherId);
            const followerRef = doc(db, "users", postPublisherId, "followers", currentUser.uid);

            const batch = writeBatch(db);

            try {
                if (isFollowing) {
                    batch.delete(followingRef);
                    batch.delete(followerRef);
                    batch.update(currentUserRef, { followingCount: increment(-1) });
                    batch.update(publisherRef, { followersCount: increment(-1) });
                } else {
                    batch.set(followingRef, { timestamp: serverTimestamp() });
                    batch.set(followerRef, { timestamp: serverTimestamp() });
                    batch.set(currentUserRef, { followingCount: increment(1) }, { merge: true });
                    batch.set(publisherRef, { followersCount: increment(1) }, { merge: true });
                }
                await batch.commit();
            } catch (e) {
                console.error("Follow error:", e);
                updateFollowBtnUI(isFollowing);
                alert("Something went wrong.");
            }
        }

        async function registerView() {
            const viewRef = doc(db, "posts", postId, "views", currentUser.uid);
            const viewSnap = await getDoc(viewRef);
            if (!viewSnap.exists()) {
                await setDoc(viewRef, { timestamp: serverTimestamp() });
                await updateDoc(doc(db, "posts", postId), { views: increment(1) });
                let vCount = parseInt(document.getElementById('viewCountDisplay').innerText);
                document.getElementById('viewCountDisplay').innerText = vCount + 1;
            }
        }

        async function checkInteractionStatus() {
            const likeRef = doc(db, "posts", postId, "likes", currentUser.uid);
            const likeSnap = await getDoc(likeRef);
            const likeBtn = document.getElementById('likeBtn');
            if(likeSnap.exists()) {
                likeBtn.classList.remove('far');
                likeBtn.classList.add('fas', 'liked-active');
            }

            const collectRef = doc(db, "posts", postId, "collects", currentUser.uid);
            const colSnap = await getDoc(collectRef);
            const collectBtn = document.getElementById('collectBtn');
            if(colSnap.exists()) {
                collectBtn.classList.remove('far');
                collectBtn.classList.add('fas', 'collected-active');
            }
        }

        document.getElementById('likeBtn').addEventListener('click', async () => {
            const btn = document.getElementById('likeBtn');
            const isLiked = btn.classList.contains('liked-active');
            const postRef = doc(db, "posts", postId);
            const likeDocRef = doc(db, "posts", postId, "likes", currentUser.uid);

            if (isLiked) {
                btn.classList.remove('fas', 'liked-active');
                btn.classList.add('far');
                document.getElementById('likeCount').innerText = parseInt(document.getElementById('likeCount').innerText) - 1;
            } else {
                btn.classList.remove('far');
                btn.classList.add('fas', 'liked-active');
                document.getElementById('likeCount').innerText = parseInt(document.getElementById('likeCount').innerText) + 1;
            }

            try {
                if (isLiked) {
                    await runTransaction(db, async (transaction) => {
                        transaction.delete(likeDocRef);
                        transaction.update(postRef, { likes: increment(-1) });
                    });
                } else {
                    await runTransaction(db, async (transaction) => {
                        transaction.set(likeDocRef, { timestamp: serverTimestamp() });
                        transaction.update(postRef, { likes: increment(1) });
                    });
                }
            } catch (e) {
                console.error("Like failed", e);
            }
        });

        document.getElementById('collectBtn').addEventListener('click', async () => {
            const btn = document.getElementById('collectBtn');
            const isCollected = btn.classList.contains('collected-active');
            const postRef = doc(db, "posts", postId);
            const colDocRef = doc(db, "posts", postId, "collects", currentUser.uid);

            if (isCollected) {
                btn.classList.remove('fas', 'collected-active');
                btn.classList.add('far');
                document.getElementById('collectCount').innerText = parseInt(document.getElementById('collectCount').innerText) - 1;
            } else {
                btn.classList.remove('far');
                btn.classList.add('fas', 'collected-active');
                document.getElementById('collectCount').innerText = parseInt(document.getElementById('collectCount').innerText) + 1;
            }

            try {
                if (isCollected) {
                    await runTransaction(db, async (transaction) => {
                        transaction.delete(colDocRef);
                        transaction.update(postRef, { collects: increment(-1) });
                    });
                } else {
                    await runTransaction(db, async (transaction) => {
                        transaction.set(colDocRef, { timestamp: serverTimestamp() });
                        transaction.update(postRef, { collects: increment(1) });
                    });
                }
            } catch (e) {
                console.error("Collect failed", e);
            }
        });

        function setupRealtimeComments() {
            const q = query(
                collection(db, "posts", postId, "comments"), 
                orderBy("likes", "desc"), 
                orderBy("createdAt", "desc")
            );
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('commentsList');
                list.innerHTML = '';
                document.getElementById('commentsTotal').innerText = snapshot.size;
                document.getElementById('commentIconCount').innerText = snapshot.size;

                snapshot.forEach(doc => {
                    const c = doc.data();
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    
                    div.innerHTML = `
                        <img src="${c.userAvatar || 'https://via.placeholder.com/32'}" class="comment-avatar">
                        <div class="comment-body">
                            <div class="comment-user">${c.userName}</div>
                            <div class="comment-text">${c.text}</div>
                            ${c.imageUrl ? `<img src="${c.imageUrl}" class="comment-image" onclick="window.viewImage('${c.imageUrl}')">` : ''}
                            <div class="comment-actions">
                                <span class="date">${c.createdAt ? new Date(c.createdAt.toDate()).toLocaleDateString() : 'Just now'}</span>
                                <span class="action-link" onclick="window.replyTo('${c.userName}')">Reply</span>
                                
                                <div class="comment-like-container" onclick="window.likeComment('${doc.id}')">
                                    <i class="far fa-heart" id="comment-heart-${doc.id}"></i>
                                    <span id="comment-count-${doc.id}">${c.likes || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                    checkCommentLikeStatus(doc.id);
                });
            }, (error) => {
                console.error("Error getting comments:", error);
            });
        }

        async function checkCommentLikeStatus(commentId) {
            if (!currentUser) return;
            try {
                const likeDoc = await getDoc(doc(db, "posts", postId, "comments", commentId, "likes", currentUser.uid));
                if (likeDoc.exists()) {
                    const icon = document.getElementById(`comment-heart-${commentId}`);
                    if (icon) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        icon.style.color = '#ff2442';
                    }
                }
            } catch (e) {}
        }

        document.getElementById('sendBtn').addEventListener('click', async () => {
            const input = document.getElementById('commentInput');
            const fileInput = document.getElementById('imgUpload');
            const text = input.value.trim();
            const file = fileInput.files[0];

            if (!text && !file) return;

            const btn = document.getElementById('sendBtn');
            btn.className = "fas fa-spinner fa-spin";

            let imageUrl = "";

            try {
                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    const data = await res.json();
                    imageUrl = data.secure_url;
                }

                await addDoc(collection(db, "posts", postId, "comments"), {
                    text: text,
                    imageUrl: imageUrl,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || "User",
                    userAvatar: currentUser.photoURL || null,
                    createdAt: serverTimestamp(),
                    likes: 0
                });

                input.value = '';
                fileInput.value = '';
                replyingTo = null;
                input.placeholder = "Say something...";

            } catch (e) {
                console.error("Comment Error", e);
                alert("Failed to send comment.");
            }
            btn.className = "fas fa-paper-plane";
        });

        window.replyTo = (name) => {
            const input = document.getElementById('commentInput');
            input.value = `@${name} `;
            input.focus();
            replyingTo = name;
        };

        window.viewImage = (url) => {
            document.getElementById('fullImage').src = url;
            document.getElementById('imageModal').style.display = 'flex';
        };

        window.likeComment = async (commentId) => {
            if (!currentUser) return;

            const heartIcon = document.getElementById(`comment-heart-${commentId}`);
            const countSpan = document.getElementById(`comment-count-${commentId}`);
            
            const commentRef = doc(db, "posts", postId, "comments", commentId);
            const likeRef = doc(db, "posts", postId, "comments", commentId, "likes", currentUser.uid);

            const isLiked = heartIcon.classList.contains('fas');
            
            if (isLiked) {
                heartIcon.classList.remove('fas');
                heartIcon.classList.add('far');
                heartIcon.style.color = '#666';
                countSpan.innerText = Math.max(0, parseInt(countSpan.innerText) - 1);
            } else {
                heartIcon.classList.remove('far');
                heartIcon.classList.add('fas');
                heartIcon.style.color = '#ff2442';
                countSpan.innerText = parseInt(countSpan.innerText) + 1;
            }

            try {
                if (isLiked) {
                    await runTransaction(db, async (transaction) => {
                        transaction.delete(likeRef);
                        transaction.update(commentRef, { likes: increment(-1) });
                    });
                } else {
                    await runTransaction(db, async (transaction) => {
                        transaction.set(likeRef, { timestamp: serverTimestamp() });
                        transaction.update(commentRef, { likes: increment(1) });
                    });
                }
            } catch (e) {
                console.error("Error liking comment:", e);
                if (isLiked) {
                    heartIcon.classList.add('fas');
                    heartIcon.classList.remove('far');
                    heartIcon.style.color = '#ff2442';
                    countSpan.innerText = parseInt(countSpan.innerText) + 1;
                } else {
                    heartIcon.classList.add('far');
                    heartIcon.classList.remove('fas');
                    heartIcon.style.color = '#666';
                    countSpan.innerText = parseInt(countSpan.innerText) - 1;
                }
            }
        };

        const emojiBtn = document.querySelector('.fa-smile');
        const emojiPicker = document.getElementById('emojiPicker');
        const commentInput = document.getElementById('commentInput');

        emojiBtn.addEventListener('click', () => {
            emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
        });

        emojiPicker.addEventListener('click', (e) => {
            if (e.target.tagName === 'I') {
                const emoji = e.target.dataset.emoji;
                if (emoji) {
                    commentInput.value += emoji;
                    commentInput.focus();
                }
            }
        });

        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.style.display = 'none';
            }
        });

    </script>
</body>
</html>