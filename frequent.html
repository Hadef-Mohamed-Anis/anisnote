<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frequent</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; background-color: #121212; font-family: 'Poppins', sans-serif; color: white; -webkit-tap-highlight-color: transparent; }

        /* Header */
        .freq-header { position: fixed; top: 0; left: 0; width: 100%; background: #121212; z-index: 100; padding-bottom: 5px; border-bottom: 1px solid #222; }
        .top-bar { display: flex; align-items: center; padding: 15px 20px; gap: 15px; }
        .back-btn { font-size: 20px; color: #fff; cursor: pointer; }
        .page-title { font-size: 16px; font-weight: 600; flex-grow: 1; text-align: center; margin-right: 20px; }

        /* User Horizontal List */
        .following-list-container { 
            padding: 10px 15px; 
            overflow-x: auto; 
            white-space: nowrap; 
            display: flex; gap: 20px;
        }
        .following-list-container::-webkit-scrollbar { display: none; }

        .f-user-node { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; opacity: 0.5; transition: all 0.3s; transform: scale(0.9); }
        .f-user-node.active { opacity: 1; transform: scale(1); }
        
        .f-node-img-wrapper { 
            width: 54px; height: 54px; border-radius: 50%; padding: 2px; position: relative;
            border: 2px solid transparent; 
            display: flex; align-items: center; justify-content: center;
        }
        .f-user-node.active .f-node-img-wrapper {
             border-color: #ff2442; 
        }

        .f-node-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #333; }
        .f-node-name { font-size: 11px; max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #ddd; }

        /* Content Grid */
        .content-grid { 
            margin-top: 160px; /* Space for fixed header */
            padding: 10px; 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            padding-bottom: 50px;
        }

        /* Card Styles */
        .home-card { background: #1e1e1e; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid #2c2c2c; }
        
        .home-card-media { position: relative; width: 100%; padding-bottom: 130%; background: #2a2a2a; overflow: hidden; }
        .home-card-media img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        
        /* New Text Post Design */
        .text-post-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #333 0%, #222 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
            text-align: center;
        }
        .text-post-content {
            font-size: 14px; font-weight: 600; color: #fff;
            line-height: 1.5;
            display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden;
        }
        .text-quote-icon { font-size: 24px; color: #ff2442; margin-bottom: 10px; opacity: 0.8; }

        .play-icon-overlay { position: absolute; top: 10px; right: 10px; font-size: 18px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.6); }
        
        .home-card-details { padding: 10px; display: flex; flex-direction: column; gap: 8px; background: #1e1e1e; flex-grow: 1; justify-content: space-between; }
        .card-title { font-size: 13px; font-weight: 500; color: #efefef; line-height: 1.4; display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; max-height: 38px;}
        
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .card-user { display: flex; align-items: center; gap: 6px; overflow: hidden; }
        .card-user-img { width: 18px; height: 18px; border-radius: 50%; background: #444; object-fit: cover; }
        .card-user-name { font-size: 11px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px; }
        .card-likes { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #888; }
        .card-likes i { color: #888; font-size: 12px; }

    </style>
</head>
<body>

    <div class="freq-header">
        <div class="top-bar">
            <i class="fas fa-chevron-left back-btn" onclick="window.location.href='home.html'"></i>
            <div class="page-title">Frequent</div>
        </div>
        
        <div class="following-list-container" id="followingList">
            </div>
    </div>

    <div class="content-grid" id="postsGrid">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuEfa4lBdoarHqUBmpWnVdYEhLYMUW0Wk",
            authDomain: "rednote-99494.firebaseapp.com",
            projectId: "rednote-99494",
            storageBucket: "rednote-99494.firebasestorage.app",
            messagingSenderId: "381708373042",
            appId: "1:381708373042:web:3b2b66b9aefba8b98bc02b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let selectedUid = new URLSearchParams(window.location.search).get('uid');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadFollowingList();
                // If a user is selected via URL, load them, otherwise the list loader will pick the first one
                if(selectedUid) {
                    loadUserContent(selectedUid);
                }
            } else {
                window.location.href = "index.html";
            }
        });

        async function loadFollowingList() {
            const listContainer = document.getElementById('followingList');
            
            // 1. Get List of User IDs I follow
            const q = query(collection(db, "users", currentUser.uid, "following"));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                listContainer.innerHTML = '<span style="color:#666; font-size:12px; padding:10px;">No following.</span>';
                document.getElementById('postsGrid').innerHTML = '<p style="text-align:center; color:#666; padding:20px;">You are not following anyone.</p>';
                return;
            }

            // 2. Extract IDs carefully to avoid "doc" naming conflict
            const userIds = [];
            snapshot.forEach(snap => {
                userIds.push(snap.id); // 'snap.id' is the userId of the person I follow
            });
            
            // 3. Fetch User Profiles
            const userDocs = await Promise.all(userIds.map(uid => getDoc(doc(db, "users", uid))));

            listContainer.innerHTML = '';
            let firstLoaded = false;

            userDocs.forEach(uDoc => {
                if(uDoc.exists()) {
                    const uData = uDoc.data();
                    const uid = uDoc.id;
                    
                    // If no UID in URL, default to first user
                    if (!selectedUid && !firstLoaded) {
                        selectedUid = uid;
                        firstLoaded = true;
                    }

                    const isActive = (uid === selectedUid);

                    const div = document.createElement('div');
                    div.className = `f-user-node ${isActive ? 'active' : ''}`;
                    div.innerHTML = `
                        <div class="f-node-img-wrapper">
                            <img src="${uData.photoURL || 'https://via.placeholder.com/50'}" class="f-node-img">
                        </div>
                        <span class="f-node-name">${uData.displayName || 'User'}</span>
                    `;
                    
                    div.onclick = () => {
                        // Update UI
                        document.querySelectorAll('.f-user-node').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        selectedUid = uid;
                        // Load Content
                        loadUserContent(uid);
                    };

                    listContainer.appendChild(div);
                }
            });

            // Initial load if not triggered by URL
            if(selectedUid && !document.getElementById('postsGrid').hasChildNodes()) {
                loadUserContent(selectedUid);
            }
        }

        async function loadUserContent(targetUid) {
            const grid = document.getElementById('postsGrid');
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#666; margin-top:20px;">Loading...</p>';

            try {
                // Fetch Author Info Once
                const authorSnap = await getDoc(doc(db, "users", targetUid));
                const authorData = authorSnap.exists() ? authorSnap.data() : {};
                const authorName = authorData.displayName || "User";
                const authorImg = authorData.photoURL || "https://via.placeholder.com/20";

                // Fetch Posts & Reels
                const postsQ = query(collection(db, "posts"), where("userId", "==", targetUid), where("isPublic", "==", true), orderBy("createdAt", "desc"));
                const reelsQ = query(collection(db, "reels"), where("userId", "==", targetUid), where("isPublic", "==", true), orderBy("createdAt", "desc"));

                const [pSnap, rSnap] = await Promise.all([getDocs(postsQ), getDocs(reelsQ)]);

                let items = [];
                pSnap.forEach(d => items.push({ id: d.id, type: 'post', ...d.data() }));
                rSnap.forEach(d => items.push({ id: d.id, type: 'reel', ...d.data() }));

                // Sort by Date
                items.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                grid.innerHTML = '';
                if(items.length === 0) {
                    grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#666; margin-top:20px;">No public posts.</p>';
                    return;
                }

                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'home-card';
                    card.onclick = () => {
                        if(item.type === 'reel') window.location.href = `publication_video.html?id=${item.id}`;
                        else window.location.href = `publication_text.html?id=${item.id}`;
                    };

                    let mediaHtml = '';
                    
                    // Logic for display: Video -> Image -> Text Art
                    if (item.type === 'reel') {
                        const thumb = item.youtubeId ? `https://img.youtube.com/vi/${item.youtubeId}/mqdefault.jpg` : 'https://via.placeholder.com/300';
                        mediaHtml = `<img src="${thumb}"><i class="fas fa-play play-icon-overlay"></i>`;
                    } else if (item.images && item.images.length > 0) {
                        mediaHtml = `<img src="${item.images[0]}">`;
                    } else {
                        // Enhanced Text Post Design
                        mediaHtml = `
                            <div class="text-post-bg">
                                <i class="fas fa-quote-left text-quote-icon"></i>
                                <div class="text-post-content">${item.content ? item.content.substring(0, 50) + '...' : '...'}</div>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <div class="home-card-media">${mediaHtml}</div>
                        <div class="home-card-details">
                            <div class="card-title">${item.title || (item.type === 'reel' ? 'Reel' : 'Thought')}</div>
                            <div class="card-footer">
                                <div class="card-user">
                                    <img src="${authorImg}" class="card-user-img">
                                    <span class="card-user-name">${authorName}</span>
                                </div>
                                <div class="card-likes">
                                    <i class="far fa-heart"></i> ${item.likes || 0}
                                </div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });

            } catch(e) {
                console.error(e);
                grid.innerHTML = '<p style="color:red; text-align:center;">Error loading content.</p>';
            }
        }
    </script>
</body>
</html>